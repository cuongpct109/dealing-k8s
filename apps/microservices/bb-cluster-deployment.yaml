apiVersion: apps/v1
kind: Deployment
metadata:
  name: bb-cluster-deployment
  namespace: app
spec:
  strategy:
    type: Recreate
  replicas: 1
  selector:
    matchLabels:
      app: bb
      version: "1"
  template:
    metadata:
      labels:
        app: bb
        version: "1"
    spec:
      volumes:
        - name: bb
          hostPath:
            path: /apps/RunningServer/Source/bb
        - name: common
          hostPath:
            path: /apps/RunningServer/Source/common
        # - name: bb-script
        #   hostPath:
        #     path: /apps/RunningServer/Source/bb/scripts/start-order.sh
        # - name: bb-log
        #   hostPath:
        #     path: /apps/RunningServer/logs/bb
      initContainers:
        - name: git-sync-common
          image: k8s.gcr.io/git-sync:v3.1.3
          volumeMounts:
            - name: common
              mountPath: /usr/src/
          env:
            - name: GIT_SYNC_REPO
              value: "https://gitlab.napaglobal.com:8888/dealing_system/common.git" ##repo-path-you-want-to-clone
            - name: GIT_SYNC_BRANCH
              value: "main" ##repo-branch
            - name: GIT_SYNC_ROOT
              value: /usr/src
            - name: GIT_SYNC_DEST
              value: "common"
            - name: GIT_SYNC_PERIOD
              value: "20"
            - name: GIT_SYNC_ONE_TIME
              value: "true"
            - name: GIT_SYNC_USERNAME
              value: "cuong.tran"
            - name: GIT_SYNC_PASSWORD
              value: "Cuong912@912"
          securityContext:
            runAsUser: 0
        - name: git-sync-app
          image: k8s.gcr.io/git-sync:v3.1.3
          volumeMounts:
            - name: bb
              mountPath: /usr/src/bb
          env:
            - name: GIT_SYNC_REPO
              value: "https://gitlab.napaglobal.com:8888/dealing_system/bb.git" ##repo-path-you-want-to-clone
            - name: GIT_SYNC_BRANCH
              value: "main" ##repo-branch
            - name: GIT_SYNC_ROOT
              value: /usr/src
            - name: GIT_SYNC_DEST
              value: "bb"
            - name: GIT_SYNC_PERIOD
              value: "20"
            - name: GIT_SYNC_ONE_TIME
              value: "true"
            - name: GIT_SYNC_USERNAME
              value: "cuong.tran"
            - name: GIT_SYNC_PASSWORD
              value: "Cuong912@912"
          securityContext:
            runAsUser: 0
        - name: jar
          tty: true
          image: cuongpct109/bb-base:init
          workingDir: /usr/src/bb
          restartPolicy: never
          command: ["gradle"]
          args: ["task", "jar"]
          volumeMounts:
            - name: bb
              mountPath: /usr/src/bb
        - name: build
          image: cuongpct109/bb-base:init
          workingDir: /usr/src/bb
          restartPolicy: never
          command: ["gradle"]
          args: ["task", "copyJars"]
          volumeMounts:
            - name: bb
              mountPath: /usr/src/bb
        - name: copy-start
          image: cuongpct109/bb-base:init
          workingDir: /usr/src/bb
          restartPolicy: never
          command: ["cp"]
          args: ["/usr/src/bb/scripts/start.sh", "/usr/src/bb/build/start.sh"]
          volumeMounts:
            - name: bb
              mountPath: /usr/src/bb
      containers:
        - name: bb
          image: cuongpct109/bb-base:start
          imagePullPolicy: IfNotPresent
          tty: true
          volumeMounts:
            - name: bb
              mountPath: /usr/src/bb/build
          command: ["sh"]
          args: ["start.sh"]
          resources:
            limits:
              memory: "2000Mi"
              cpu: "1000m"
