apiVersion: v1
data:
  runbroker.sh: "#!/bin/sh\n\n# Licensed to the Apache Software Foundation
    (ASF) under one or more\n# contributor license agreements.  See the NOTICE file
    distributed with\n# this work for additional information regarding copyright ownership.\n#
    The ASF licenses this file to You under the Apache License, Version 2.0\n# (the
    \"License\"); you may not use this file except in compliance with\n# the License.
    \ You may obtain a copy of the License at cuong\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n#
    Unless required by applicable law or agreed to in writing, software\n# distributed
    under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES
    OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the
    specific language governing permissions and\n# limitations under the License.\n\n#===========================================================================================\n#
    Java Environment Setting\n#===========================================================================================\nerror_exit
    ()\n{\n    echo \"ERROR: $1 !!\"\n    exit 1\n}\n\n[ ! -e \"$JAVA_HOME/bin/java\"
    ] && JAVA_HOME=$HOME/jdk/java\n[ ! -e \"$JAVA_HOME/bin/java\" ] && JAVA_HOME=/usr/java\n[
    ! -e \"$JAVA_HOME/bin/java\" ] && error_exit \"Please set the JAVA_HOME variable
    in your environment, We need java(x64)!\"\n\nexport JAVA_HOME\nexport JAVA=\"$JAVA_HOME/bin/java\"\nexport
    BASE_DIR=$(dirname $0)/..\nexport CLASSPATH=.:${BASE_DIR}/conf:${CLASSPATH}\n\n#===========================================================================================\n#
    JVM Configuration\n#===========================================================================================\n#
    Get the max heap used by a jvm, which used all the ram available to the container.\nMAX_POSSIBLE_HEAP_STR=$(java
    -XX:+UnlockExperimentalVMOptions -XX:MaxRAMFraction=1 -XshowSettings:vm -version
    |& awk '/Max\\. Heap Size \\(Estimated\\): [0-9KMG]+/{ print $5}')\nMAX_POSSIBLE_HEAP=$MAX_POSSIBLE_HEAP_STR\nCAL_UNIT=${MAX_POSSIBLE_HEAP_STR:
    -1}\nif [ \"$CAL_UNIT\" == \"G\" -o \"$CAL_UNIT\" == \"g\" ]; then\n  MAX_POSSIBLE_HEAP=$(echo
    ${MAX_POSSIBLE_HEAP_STR:0:${#MAX_POSSIBLE_HEAP_STR}-1} `expr 1 \\* 1024 \\* 1024
    \\* 1024` | awk '{printf \"%d\",$1*$2}')\nelif [ \"$CAL_UNIT\" == \"M\" -o \"$CAL_UNIT\"
    == \"m\" ]; then\n  MAX_POSSIBLE_HEAP=$(echo ${MAX_POSSIBLE_HEAP_STR:0:${#MAX_POSSIBLE_HEAP_STR}-1}
    `expr 1 \\* 1024 \\* 1024` | awk '{printf \"%d\",$1*$2}')\nelif [ \"$CAL_UNIT\"
    == \"K\" -o \"$CAL_UNIT\" == \"k\" ]; then\n  MAX_POSSIBLE_HEAP=$(echo ${MAX_POSSIBLE_HEAP_STR:0:${#MAX_POSSIBLE_HEAP_STR}-1}
    `expr 1 \\* 1024` | awk '{printf \"%d\",$1*$2}')\nfi\n\n# Dynamically calculate
    parameters, for reference.\nXms=$[MAX_POSSIBLE_HEAP/80]\nXmx=$[MAX_POSSIBLE_HEAP/40]\nXmn=$[MAX_POSSIBLE_HEAP/80]\nMaxDirectMemorySize=$[MAX_POSSIBLE_HEAP/4]\n#
    Set for `JAVA_OPT`.\nJAVA_OPT=\"${JAVA_OPT} -server -Xms${Xms} -Xmx${Xmx} -Xmn${Xmn}\"\nJAVA_OPT=\"${JAVA_OPT}
    -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30
    -XX:SoftRefLRUPolicyMSPerMB=0 -XX:SurvivorRatio=8\"\nJAVA_OPT=\"${JAVA_OPT} -verbose:gc
    -Xloggc:/dev/shm/mq_gc_%p.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime
    -XX:+PrintAdaptiveSizePolicy\"\nJAVA_OPT=\"${JAVA_OPT} -XX:+UseGCLogFileRotation
    -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=30m\"\nJAVA_OPT=\"${JAVA_OPT} -XX:-OmitStackTraceInFastThrow\"\nJAVA_OPT=\"${JAVA_OPT}
    -XX:+AlwaysPreTouch\"\nJAVA_OPT=\"${JAVA_OPT} -XX:MaxDirectMemorySize=${MaxDirectMemorySize}\"\nJAVA_OPT=\"${JAVA_OPT}
    -XX:-UseLargePages -XX:-UseBiasedLocking\"\nJAVA_OPT=\"${JAVA_OPT} -Djava.ext.dirs=${JAVA_HOME}/jre/lib/ext:${BASE_DIR}/lib\"\nJAVA_OPT=\"${JAVA_OPT}
    -Xdebug -Xrunjdwp:transport=dt_socket,address=9555,server=y,suspend=n\"\nJAVA_OPT=\"${JAVA_OPT}
    ${JAVA_OPT_EXT}\"\nJAVA_OPT=\"${JAVA_OPT} -cp ${CLASSPATH}\"\n\nnumactl --interleave=all
    pwd > /dev/null 2>&1\nif [ $? -eq 0 ]\nthen\n\tif [ -z \"$RMQ_NUMA_NODE\" ] ;
    then\n\t\tnumactl --interleave=all $JAVA ${JAVA_OPT} $@\n\telse\n\t\tnumactl --cpunodebind=$RMQ_NUMA_NODE
    --membind=$RMQ_NUMA_NODE $JAVA ${JAVA_OPT} $@\n\tfi\nelse\n\t$JAVA ${JAVA_OPT}
    $@\nfi\n"
kind: ConfigMap
metadata:
  name: runbroker
  namespace: database
